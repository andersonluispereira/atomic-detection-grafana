attack_technique: T1001.002
display_name: Data Obfuscation via Steganography
detections:
  - name: Execute Embedded Script in Image via Steganography
    description: |
      Steganographic payload execution on Linux often relies on chaining multiple command-line utilities to extract hidden data, decode it, and execute it. Monitoring parent-child process relationships and short-interval binary diversity enables detection of this behavior without relying on file content inspection.
    references:
      atomic_red_team: https://github.com/redcanaryco/atomic-red-team/tree/master/atomics/T1001.002
      mitre_attack: https://attack.mitre.org/techniques/T1001/002/
    platforms:
      - linux
    logsource:
      auditd:
        description: |
          Monitor Linux process creation and execution events.
        rules:
          - "-a exit,always -F arch=b64 -S execve"
          - "-a exit,always -F arch=b32 -S execve"
    detection:
      loki:
        description: |
          Detects potential steganography-based execution where a single parent process rapidly spawns multiple utilities commonly used to extract, decode, or manipulate embedded data from files (cat, base64, xxd, sed, xargs, tail, strings, bash).
          The detection counts distinct binaries executed by the same parent process and triggers when more than 3 unique utilities are observed within a short time window. The corresponding Atomic Red Team test is composed of 2 logical stages: the first creates a modified image containing an embedded script, and the second extracts and executes the embedded payload.
          By requiring more than 3 distinct utilities, the query is designed to trigger both when the full test chain is executed end-to-end or when only the extraction and execution stage runs, assuming the modified image already exists on disk.
        query: |
          count by (hostname, ppid) (
            sum by (hostname, ppid, exe) (
              count_over_time(
                {service_name="fluentbit-audit"}
                | logfmt
                | exe =~ "/usr/bin/(cat|base64|xxd|sed|xargs|tail|strings|bash)"
                [10s] #short time window
              )
            )
          ) > 3